# Budget Helper Maintenance Guide

This guide covers how the add-in is structured, how to test it, and where key assets live.

## Repo Layout

- `budget-helper/`: add-in source (TypeScript, Office.js, webpack)
- `budget-helper/dist`: local build output (generated by webpack)
- `assets/`: source icons and branding assets
- `docs/`: documentation
- `tools/`: scripts for workbook maintenance

## Core Modules

- `budget-helper/src/taskpane/taskpane.ts`: UI controller, wires DOM events to logic.
- `budget-helper/src/transaction.ts`: CSV parsing, ID generation, categorization rules.
- `budget-helper/src/rollover.ts`: Rollover calculations and bulk writes.
- `budget-helper/src/lookups.ts`: Excel read layer (tables, named ranges).
- `budget-helper/src/excel-helpers.ts`: Excel write helpers (tables, ranges).

## Development Workflow

### Prerequisites
- Node.js + npm
- LibreOffice via Flatpak for `tools/xlsx/recalc.py`

## Manifest Versioning (Required for M365 Updates)

Office add-ins only update when the hosted `manifest.xml` has a higher `<Version>` than what’s installed.

Rule of thumb:
- Always bump `<Version>` in `budget-helper/manifest.xml` for every release (usually increment the last number).
- Rebuild + publish so the hosted manifest is updated as well.

If GitHub Pages is configured to serve from `docs/`, use:
```bash
cd budget-helper
npm ci
npm test
npm run build:docs
```
This produces `budget-helper/dist/manifest.xml` and syncs the whole bundle into `docs/manifest.xml` (plus `taskpane.html`, `commands.html`, JS/CSS, and icons).

### Commands

```bash
cd budget-helper
npm ci
npm test
npm run build
```

### Testing Notes
- Jest tests mock the global `Excel` object and table lookups.
- Key coverage: `rollover`, `excel-helpers`, `lookups`, `transaction`, `file-drop`.

## Workbook Tooling

- `tools/xlsx/unpack_xlsx.py`: Export workbook structure and sparse cell data.
- `tools/xlsx/recalc.py`: Recalculate formulas and scan for errors.

## GitHub Pages Hosting

This add-in is hosted as static files (HTML/JS/CSS + `manifest.xml`).

Notes:
- GitHub Pages does not require a `docs/` folder; it can be configured to deploy from a branch folder (e.g. `/docs`) or via GitHub Actions (recommended).
- The Microsoft 365 app registration should point to the hosted `manifest.xml` URL (the manifest then points Excel to `taskpane.html`, `commands.html`, and icons).

## Roadmap (v2.0+)

Near-term cleanup and reliability:
- Make calc/recalc deterministic and fast as data grows (reduce Excel round-trips, avoid nested `Excel.run`, add guardrails).
- Improve taskpane logging so the add-in is debuggable without opening devtools.
- Fix UX footguns (dropdown scope, month/year persistence, clearer “what will happen” labels).

Automation features to reduce manual spreadsheet work:
- **Update budget going forward:** write a `BudgetHistory` entry that captures the *previous* amount for the exact date range gap up to the change, then apply the new amount going forward.
- **Transfer between buckets:** create paired “rebalance” transactions (one negative, one positive) so category totals and rollovers reflect the move.
- **Accrual assistance:** helpers for common Accrual tab workflows (create/update accrual targets, monthly allocation guidance, progress logging).

## Known Issues

### `tmp` Vulnerability
`office-addin-debugging` pulls in a low-severity `tmp` vulnerability (GHSA-52f5-9888-hmc6). Attempts to remediate via `npm audit fix` and dependency bumps did not clear it. This is a dev-only dependency and does not affect the production add-in bundle.

## Gotchas

- Excel dates are 1-based for month inputs.
- `resetRollover` must avoid Excel reads inside the loop; data is preloaded into `Map` objects.
- `rollover.test.ts` uses `jest.requireActual` for internal calls; do not remove that pattern.
